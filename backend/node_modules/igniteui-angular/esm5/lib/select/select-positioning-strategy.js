import { __extends } from "tslib";
import { VerticalAlignment, HorizontalAlignment, Util } from '../services/overlay/utilities';
import { fadeOut, fadeIn } from '../animations/main';
import { isIE } from '../core/utils';
import { BaseFitPositionStrategy } from '../services/overlay/position/base-fit-position-strategy';
/** @hidden @internal */
var SelectPositioningStrategy = /** @class */ (function (_super) {
    __extends(SelectPositioningStrategy, _super);
    function SelectPositioningStrategy(select, settings) {
        var _this = _super.call(this) || this;
        _this.select = select;
        _this._selectDefaultSettings = {
            horizontalDirection: HorizontalAlignment.Right,
            verticalDirection: VerticalAlignment.Bottom,
            horizontalStartPoint: HorizontalAlignment.Left,
            verticalStartPoint: VerticalAlignment.Top,
            openAnimation: fadeIn,
            closeAnimation: fadeOut
        };
        // Global variables required for cases of !initialCall (page scroll/overlay repositionAll)
        _this.global_yOffset = 0;
        _this.global_xOffset = 0;
        _this.global_styles = {};
        _this.settings = Object.assign({}, _this._selectDefaultSettings, settings);
        return _this;
    }
    /** @inheritdoc */
    SelectPositioningStrategy.prototype.position = function (contentElement, size, document, initialCall) {
        this.select.scrollContainer.scrollTop = 0;
        var rects = _super.prototype.calculateElementRectangles.call(this, contentElement);
        // selectFit obj, to be used for both cases of initialCall and !initialCall(page scroll/overlay repositionAll)
        var selectFit = {
            verticalOffset: this.global_yOffset,
            horizontalOffset: this.global_xOffset,
            targetRect: rects.targetRect,
            contentElementRect: rects.elementRect,
            styles: this.global_styles,
            scrollContainer: this.select.scrollContainer,
            scrollContainerRect: this.select.scrollContainer.getBoundingClientRect()
        };
        if (initialCall) {
            // Fill in the required selectFit object properties.
            selectFit.viewPortRect = Util.getViewportRect(document);
            selectFit.itemElement = this.getInteractionItemElement();
            selectFit.itemRect = selectFit.itemElement.getBoundingClientRect();
            // Calculate input and selected item elements style related variables
            selectFit.styles = this.calculateStyles(selectFit);
            selectFit.scrollAmount = this.calculateScrollAmount(selectFit);
            // Calculate how much to offset the overlay container.
            this.calculateYoffset(selectFit);
            this.calculateXoffset(selectFit);
            _super.prototype.updateViewPortFit.call(this, selectFit);
            // container does not fit in viewPort and is out on Top or Bottom
            if (selectFit.fitVertical.back < 0 || selectFit.fitVertical.forward < 0) {
                this.fitInViewport(contentElement, selectFit);
            }
            this.select.scrollContainer.scrollTop = selectFit.scrollAmount;
        }
        this.setStyles(contentElement, selectFit);
    };
    /**
     * Calculate selected item scroll position.
     */
    SelectPositioningStrategy.prototype.calculateScrollAmount = function (selectFit) {
        var itemElementRect = selectFit.itemRect;
        var scrollContainer = selectFit.scrollContainer;
        var scrollContainerRect = selectFit.scrollContainerRect;
        var scrollDelta = scrollContainerRect.top - itemElementRect.top;
        var scrollPosition = scrollContainer.scrollTop - scrollDelta;
        var dropDownHeight = scrollContainer.clientHeight;
        scrollPosition -= dropDownHeight / 2;
        scrollPosition += itemElementRect.height / 2;
        return Math.round(Math.min(Math.max(0, scrollPosition), scrollContainer.scrollHeight - scrollContainerRect.height));
    };
    /**
     * Position the items outer container so selected item text is positioned over input text and if header
     * And/OR footer - both header/footer are visible
     * @param selectFit selectFit to use for computation.
     */
    SelectPositioningStrategy.prototype.fitInViewport = function (contentElement, selectFit) {
        var footer = selectFit.scrollContainerRect.bottom - selectFit.contentElementRect.bottom;
        var header = selectFit.scrollContainerRect.top - selectFit.contentElementRect.top;
        var lastItemFitSize = selectFit.targetRect.bottom + selectFit.styles.itemTextToInputTextDiff - footer;
        var firstItemFitSize = selectFit.targetRect.top - selectFit.styles.itemTextToInputTextDiff - header;
        // out of viewPort on Top
        if (selectFit.fitVertical.back < 0) {
            var possibleScrollAmount = selectFit.scrollContainer.scrollHeight -
                selectFit.scrollContainerRect.height - selectFit.scrollAmount;
            if (possibleScrollAmount + selectFit.fitVertical.back > 0 && firstItemFitSize > selectFit.viewPortRect.top) {
                selectFit.scrollAmount -= selectFit.fitVertical.back;
                selectFit.verticalOffset -= selectFit.fitVertical.back;
                this.global_yOffset = selectFit.verticalOffset;
            }
            else {
                selectFit.verticalOffset = 0;
                this.global_yOffset = 0;
            }
            // out of viewPort on Bottom
        }
        else if (selectFit.fitVertical.forward < 0) {
            if (selectFit.scrollAmount + selectFit.fitVertical.forward > 0 && lastItemFitSize < selectFit.viewPortRect.bottom) {
                selectFit.scrollAmount += selectFit.fitVertical.forward;
                selectFit.verticalOffset += selectFit.fitVertical.forward;
                this.global_yOffset = selectFit.verticalOffset;
            }
            else {
                selectFit.verticalOffset = -selectFit.contentElementRect.height + selectFit.targetRect.height;
                this.global_yOffset = selectFit.verticalOffset;
            }
        }
    };
    /**
     * Sets element's style which effectively positions the provided element
     * @param element Element to position
     * @param selectFit selectFit to use for computation.
     * @param initialCall should be true if this is the initial call to the position method calling setStyles
     */
    SelectPositioningStrategy.prototype.setStyles = function (contentElement, selectFit) {
        _super.prototype.setStyle.call(this, contentElement, selectFit.targetRect, selectFit.contentElementRect, selectFit);
        contentElement.style.width = selectFit.styles.contentElementNewWidth + "px"; // manage container based on paddings?
        this.global_styles.contentElementNewWidth = selectFit.styles.contentElementNewWidth;
    };
    /**
     * Calculate the necessary input and selected item styles to be used for positioning item text over input text.
     * Calculate & Set default items container width.
     * @param selectFit selectFit to use for computation.
     */
    SelectPositioningStrategy.prototype.calculateStyles = function (selectFit) {
        var styles = {};
        var inputElementStyles = window.getComputedStyle(this.settings.target);
        var itemElementStyles = window.getComputedStyle(selectFit.itemElement);
        var numericInputFontSize = parseFloat(inputElementStyles.fontSize);
        var numericItemFontSize = parseFloat(itemElementStyles.fontSize);
        var inputTextToInputTop = (selectFit.targetRect.bottom - selectFit.targetRect.top - numericInputFontSize) / 2;
        var itemTextToItemTop = (selectFit.itemRect.height - numericItemFontSize) / 2;
        // Adjust for input top padding
        var negateInputPaddings = (parseFloat(inputElementStyles.paddingTop) -
            parseFloat(inputElementStyles.paddingBottom)) / 2;
        styles.itemTextToInputTextDiff = Math.round(itemTextToItemTop - inputTextToInputTop + negateInputPaddings);
        var numericLeftPadding = parseFloat(itemElementStyles.paddingLeft);
        var numericTextIndent = parseFloat(itemElementStyles.textIndent);
        styles.itemTextPadding = numericLeftPadding;
        styles.itemTextIndent = numericTextIndent;
        // 24 is the input's toggle ddl icon width
        styles.contentElementNewWidth = selectFit.targetRect.width + 24 + numericLeftPadding * 2;
        return styles;
    };
    /**
     * Obtain the selected item if there is such one or otherwise use the first one
     */
    SelectPositioningStrategy.prototype.getInteractionItemElement = function () {
        var itemElement;
        if (this.select.selectedItem) {
            itemElement = this.select.selectedItem.element.nativeElement;
            // D.P. Feb 22 2019, #3921 Force item scroll before measuring in IE11, due to base scrollToItem delay
            if (isIE()) {
                this.select.scrollContainer.scrollTop = this.select.calculateScrollPosition(this.select.selectedItem);
            }
        }
        else {
            itemElement = this.select.getFirstItemElement();
        }
        return itemElement;
    };
    /**
     * Calculate how much to offset the overlay container for Y-axis.
     */
    SelectPositioningStrategy.prototype.calculateYoffset = function (selectFit) {
        selectFit.verticalOffset = -(selectFit.itemRect.top - selectFit.contentElementRect.top +
            selectFit.styles.itemTextToInputTextDiff - selectFit.scrollAmount);
        this.global_yOffset = selectFit.verticalOffset;
    };
    /**
     * Calculate how much to offset the overlay container for X-axis.
     */
    SelectPositioningStrategy.prototype.calculateXoffset = function (selectFit) {
        selectFit.horizontalOffset = selectFit.styles.itemTextIndent - selectFit.styles.itemTextPadding;
        this.global_xOffset = selectFit.horizontalOffset;
    };
    return SelectPositioningStrategy;
}(BaseFitPositionStrategy));
export { SelectPositioningStrategy };
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoic2VsZWN0LXBvc2l0aW9uaW5nLXN0cmF0ZWd5LmpzIiwic291cmNlUm9vdCI6Im5nOi8vaWduaXRldWktYW5ndWxhci8iLCJzb3VyY2VzIjpbImxpYi9zZWxlY3Qvc2VsZWN0LXBvc2l0aW9uaW5nLXN0cmF0ZWd5LnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiI7QUFBQSxPQUFPLEVBQUUsaUJBQWlCLEVBQUUsbUJBQW1CLEVBQTBCLElBQUksRUFBaUIsTUFBTSwrQkFBK0IsQ0FBQztBQUVwSSxPQUFPLEVBQUUsT0FBTyxFQUFFLE1BQU0sRUFBRSxNQUFNLG9CQUFvQixDQUFDO0FBRXJELE9BQU8sRUFBRSxJQUFJLEVBQUUsTUFBTSxlQUFlLENBQUM7QUFDckMsT0FBTyxFQUFFLHVCQUF1QixFQUFFLE1BQU0seURBQXlELENBQUM7QUFFbEcsd0JBQXdCO0FBQ3hCO0lBQStDLDZDQUF1QjtJQWNsRSxtQ0FBbUIsTUFBcUIsRUFBRSxRQUEyQjtRQUFyRSxZQUNJLGlCQUFPLFNBRVY7UUFIa0IsWUFBTSxHQUFOLE1BQU0sQ0FBZTtRQVpoQyw0QkFBc0IsR0FBRztZQUM3QixtQkFBbUIsRUFBRSxtQkFBbUIsQ0FBQyxLQUFLO1lBQzlDLGlCQUFpQixFQUFFLGlCQUFpQixDQUFDLE1BQU07WUFDM0Msb0JBQW9CLEVBQUUsbUJBQW1CLENBQUMsSUFBSTtZQUM5QyxrQkFBa0IsRUFBRSxpQkFBaUIsQ0FBQyxHQUFHO1lBQ3pDLGFBQWEsRUFBRSxNQUFNO1lBQ3JCLGNBQWMsRUFBRSxPQUFPO1NBQzFCLENBQUM7UUFVRiwwRkFBMEY7UUFDbEYsb0JBQWMsR0FBRyxDQUFDLENBQUM7UUFDbkIsb0JBQWMsR0FBRyxDQUFDLENBQUM7UUFDbkIsbUJBQWEsR0FBaUIsRUFBRSxDQUFDO1FBTnJDLEtBQUksQ0FBQyxRQUFRLEdBQUcsTUFBTSxDQUFDLE1BQU0sQ0FBQyxFQUFFLEVBQUUsS0FBSSxDQUFDLHNCQUFzQixFQUFFLFFBQVEsQ0FBQyxDQUFDOztJQUM3RSxDQUFDO0lBT0Qsa0JBQWtCO0lBQ2xCLDRDQUFRLEdBQVIsVUFBUyxjQUEyQixFQUFFLElBQVUsRUFBRSxRQUFtQixFQUFFLFdBQXFCO1FBQ3hGLElBQUksQ0FBQyxNQUFNLENBQUMsZUFBZSxDQUFDLFNBQVMsR0FBRyxDQUFDLENBQUM7UUFDMUMsSUFBTSxLQUFLLEdBQUcsaUJBQU0sMEJBQTBCLFlBQUMsY0FBYyxDQUFDLENBQUM7UUFDL0QsOEdBQThHO1FBQzlHLElBQU0sU0FBUyxHQUFjO1lBQ3pCLGNBQWMsRUFBRSxJQUFJLENBQUMsY0FBYztZQUNuQyxnQkFBZ0IsRUFBRSxJQUFJLENBQUMsY0FBYztZQUNyQyxVQUFVLEVBQUUsS0FBSyxDQUFDLFVBQVU7WUFDNUIsa0JBQWtCLEVBQUUsS0FBSyxDQUFDLFdBQVc7WUFDckMsTUFBTSxFQUFFLElBQUksQ0FBQyxhQUFhO1lBQzFCLGVBQWUsRUFBRSxJQUFJLENBQUMsTUFBTSxDQUFDLGVBQWU7WUFDNUMsbUJBQW1CLEVBQUUsSUFBSSxDQUFDLE1BQU0sQ0FBQyxlQUFlLENBQUMscUJBQXFCLEVBQUU7U0FDM0UsQ0FBQztRQUVGLElBQUksV0FBVyxFQUFFO1lBQ2Isb0RBQW9EO1lBQ3BELFNBQVMsQ0FBQyxZQUFZLEdBQUcsSUFBSSxDQUFDLGVBQWUsQ0FBQyxRQUFRLENBQUMsQ0FBQztZQUN4RCxTQUFTLENBQUMsV0FBVyxHQUFHLElBQUksQ0FBQyx5QkFBeUIsRUFBRSxDQUFDO1lBQ3pELFNBQVMsQ0FBQyxRQUFRLEdBQUcsU0FBUyxDQUFDLFdBQVcsQ0FBQyxxQkFBcUIsRUFBRSxDQUFDO1lBRW5FLHFFQUFxRTtZQUNyRSxTQUFTLENBQUMsTUFBTSxHQUFHLElBQUksQ0FBQyxlQUFlLENBQUMsU0FBUyxDQUFDLENBQUM7WUFFbkQsU0FBUyxDQUFDLFlBQVksR0FBRyxJQUFJLENBQUMscUJBQXFCLENBQUMsU0FBUyxDQUFDLENBQUM7WUFDL0Qsc0RBQXNEO1lBQ3RELElBQUksQ0FBQyxnQkFBZ0IsQ0FBQyxTQUFTLENBQUMsQ0FBQztZQUNqQyxJQUFJLENBQUMsZ0JBQWdCLENBQUMsU0FBUyxDQUFDLENBQUM7WUFFakMsaUJBQU0saUJBQWlCLFlBQUMsU0FBUyxDQUFDLENBQUM7WUFDbkMsaUVBQWlFO1lBQ2pFLElBQUksU0FBUyxDQUFDLFdBQVcsQ0FBQyxJQUFJLEdBQUcsQ0FBQyxJQUFJLFNBQVMsQ0FBQyxXQUFXLENBQUMsT0FBTyxHQUFHLENBQUMsRUFBRztnQkFDdEUsSUFBSSxDQUFDLGFBQWEsQ0FBQyxjQUFjLEVBQUUsU0FBUyxDQUFDLENBQUM7YUFDakQ7WUFDRCxJQUFJLENBQUMsTUFBTSxDQUFDLGVBQWUsQ0FBQyxTQUFTLEdBQUcsU0FBUyxDQUFDLFlBQVksQ0FBQztTQUNsRTtRQUNELElBQUksQ0FBQyxTQUFTLENBQUMsY0FBYyxFQUFFLFNBQVMsQ0FBQyxDQUFDO0lBQzlDLENBQUM7SUFFRDs7T0FFRztJQUNLLHlEQUFxQixHQUE3QixVQUE4QixTQUFvQjtRQUM5QyxJQUFNLGVBQWUsR0FBRyxTQUFTLENBQUMsUUFBUSxDQUFDO1FBQzNDLElBQU0sZUFBZSxHQUFHLFNBQVMsQ0FBQyxlQUFlLENBQUM7UUFDbEQsSUFBTSxtQkFBbUIsR0FBRyxTQUFTLENBQUMsbUJBQW1CLENBQUM7UUFDMUQsSUFBTSxXQUFXLEdBQUcsbUJBQW1CLENBQUMsR0FBRyxHQUFHLGVBQWUsQ0FBQyxHQUFHLENBQUM7UUFDbEUsSUFBSSxjQUFjLEdBQUcsZUFBZSxDQUFDLFNBQVMsR0FBRyxXQUFXLENBQUM7UUFFN0QsSUFBTSxjQUFjLEdBQUcsZUFBZSxDQUFDLFlBQVksQ0FBQztRQUNwRCxjQUFjLElBQUksY0FBYyxHQUFHLENBQUMsQ0FBQztRQUNyQyxjQUFjLElBQUksZUFBZSxDQUFDLE1BQU0sR0FBRyxDQUFDLENBQUM7UUFFN0MsT0FBTyxJQUFJLENBQUMsS0FBSyxDQUFDLElBQUksQ0FBQyxHQUFHLENBQUMsSUFBSSxDQUFDLEdBQUcsQ0FBQyxDQUFDLEVBQUUsY0FBYyxDQUFDLEVBQUUsZUFBZSxDQUFDLFlBQVksR0FBRyxtQkFBbUIsQ0FBQyxNQUFNLENBQUMsQ0FBQyxDQUFDO0lBQ3hILENBQUM7SUFFRDs7OztPQUlHO0lBQ08saURBQWEsR0FBdkIsVUFBd0IsY0FBMkIsRUFBRSxTQUFvQjtRQUNyRSxJQUFNLE1BQU0sR0FBRyxTQUFTLENBQUMsbUJBQW1CLENBQUMsTUFBTSxHQUFHLFNBQVMsQ0FBQyxrQkFBa0IsQ0FBQyxNQUFNLENBQUM7UUFDMUYsSUFBTSxNQUFNLEdBQUcsU0FBUyxDQUFDLG1CQUFtQixDQUFDLEdBQUcsR0FBRyxTQUFTLENBQUMsa0JBQWtCLENBQUMsR0FBRyxDQUFDO1FBQ3BGLElBQU0sZUFBZSxHQUFHLFNBQVMsQ0FBQyxVQUFVLENBQUMsTUFBTSxHQUFHLFNBQVMsQ0FBQyxNQUFNLENBQUMsdUJBQXVCLEdBQUcsTUFBTSxDQUFDO1FBQ3hHLElBQU0sZ0JBQWdCLEdBQUcsU0FBUyxDQUFDLFVBQVUsQ0FBQyxHQUFHLEdBQUcsU0FBUyxDQUFDLE1BQU0sQ0FBQyx1QkFBdUIsR0FBRyxNQUFNLENBQUM7UUFDdEcseUJBQXlCO1FBQ3pCLElBQUksU0FBUyxDQUFDLFdBQVcsQ0FBQyxJQUFJLEdBQUcsQ0FBQyxFQUFFO1lBQ2hDLElBQU0sb0JBQW9CLEdBQUcsU0FBUyxDQUFDLGVBQWUsQ0FBQyxZQUFZO2dCQUMvRCxTQUFTLENBQUMsbUJBQW1CLENBQUMsTUFBTSxHQUFHLFNBQVMsQ0FBQyxZQUFZLENBQUM7WUFDbEUsSUFBSSxvQkFBb0IsR0FBRyxTQUFTLENBQUMsV0FBVyxDQUFDLElBQUksR0FBRyxDQUFDLElBQUksZ0JBQWdCLEdBQUcsU0FBUyxDQUFDLFlBQVksQ0FBQyxHQUFHLEVBQUU7Z0JBQ3hHLFNBQVMsQ0FBQyxZQUFZLElBQUksU0FBUyxDQUFDLFdBQVcsQ0FBQyxJQUFJLENBQUM7Z0JBQ3JELFNBQVMsQ0FBQyxjQUFjLElBQUksU0FBUyxDQUFDLFdBQVcsQ0FBQyxJQUFJLENBQUM7Z0JBQ3ZELElBQUksQ0FBQyxjQUFjLEdBQUcsU0FBUyxDQUFDLGNBQWMsQ0FBQzthQUNsRDtpQkFBTTtnQkFDSCxTQUFTLENBQUMsY0FBYyxHQUFHLENBQUMsQ0FBRTtnQkFDOUIsSUFBSSxDQUFDLGNBQWMsR0FBRyxDQUFDLENBQUM7YUFDM0I7WUFDTCw0QkFBNEI7U0FDM0I7YUFBTSxJQUFJLFNBQVMsQ0FBQyxXQUFXLENBQUMsT0FBTyxHQUFHLENBQUMsRUFBRTtZQUMxQyxJQUFJLFNBQVMsQ0FBQyxZQUFZLEdBQUcsU0FBUyxDQUFDLFdBQVcsQ0FBQyxPQUFPLEdBQUcsQ0FBQyxJQUFJLGVBQWUsR0FBRyxTQUFTLENBQUMsWUFBWSxDQUFDLE1BQU0sRUFBRTtnQkFDL0csU0FBUyxDQUFDLFlBQVksSUFBSSxTQUFTLENBQUMsV0FBVyxDQUFDLE9BQU8sQ0FBQztnQkFDeEQsU0FBUyxDQUFDLGNBQWMsSUFBSSxTQUFTLENBQUMsV0FBVyxDQUFDLE9BQU8sQ0FBQztnQkFDMUQsSUFBSSxDQUFDLGNBQWMsR0FBRyxTQUFTLENBQUMsY0FBYyxDQUFDO2FBQ2xEO2lCQUFNO2dCQUNILFNBQVMsQ0FBQyxjQUFjLEdBQUcsQ0FBQyxTQUFTLENBQUMsa0JBQWtCLENBQUMsTUFBTSxHQUFHLFNBQVMsQ0FBQyxVQUFVLENBQUMsTUFBTSxDQUFDO2dCQUM5RixJQUFJLENBQUMsY0FBYyxHQUFHLFNBQVMsQ0FBQyxjQUFjLENBQUM7YUFDbEQ7U0FDSjtJQUNMLENBQUM7SUFFRDs7Ozs7T0FLRztJQUNPLDZDQUFTLEdBQW5CLFVBQW9CLGNBQTJCLEVBQUUsU0FBb0I7UUFDakUsaUJBQU0sUUFBUSxZQUFDLGNBQWMsRUFBRSxTQUFTLENBQUMsVUFBVSxFQUFFLFNBQVMsQ0FBQyxrQkFBa0IsRUFBRSxTQUFTLENBQUMsQ0FBQztRQUM5RixjQUFjLENBQUMsS0FBSyxDQUFDLEtBQUssR0FBTSxTQUFTLENBQUMsTUFBTSxDQUFDLHNCQUFzQixPQUFJLENBQUMsQ0FBQyxzQ0FBc0M7UUFDbkgsSUFBSSxDQUFDLGFBQWEsQ0FBQyxzQkFBc0IsR0FBRyxTQUFTLENBQUMsTUFBTSxDQUFDLHNCQUFzQixDQUFDO0lBQ3hGLENBQUM7SUFFRDs7OztPQUlHO0lBQ0ssbURBQWUsR0FBdkIsVUFBd0IsU0FBb0I7UUFDeEMsSUFBTSxNQUFNLEdBQWlCLEVBQUUsQ0FBQztRQUNoQyxJQUFNLGtCQUFrQixHQUFHLE1BQU0sQ0FBQyxnQkFBZ0IsQ0FBQyxJQUFJLENBQUMsUUFBUSxDQUFDLE1BQWlCLENBQUMsQ0FBQztRQUNwRixJQUFNLGlCQUFpQixHQUFHLE1BQU0sQ0FBQyxnQkFBZ0IsQ0FBQyxTQUFTLENBQUMsV0FBVyxDQUFDLENBQUM7UUFDekUsSUFBTSxvQkFBb0IsR0FBRyxVQUFVLENBQUMsa0JBQWtCLENBQUMsUUFBUSxDQUFDLENBQUM7UUFDckUsSUFBTSxtQkFBbUIsR0FBRyxVQUFVLENBQUMsaUJBQWlCLENBQUMsUUFBUSxDQUFDLENBQUM7UUFDbkUsSUFBTSxtQkFBbUIsR0FBRyxDQUFDLFNBQVMsQ0FBQyxVQUFVLENBQUMsTUFBTSxHQUFHLFNBQVMsQ0FBQyxVQUFVLENBQUMsR0FBRyxHQUFHLG9CQUFvQixDQUFDLEdBQUcsQ0FBQyxDQUFDO1FBQ2hILElBQU0saUJBQWlCLEdBQUcsQ0FBQyxTQUFTLENBQUMsUUFBUSxDQUFDLE1BQU0sR0FBRyxtQkFBbUIsQ0FBQyxHQUFHLENBQUMsQ0FBQztRQUMvRSwrQkFBK0I7UUFDaEMsSUFBTSxtQkFBbUIsR0FBRyxDQUNwQixVQUFVLENBQUMsa0JBQWtCLENBQUMsVUFBVSxDQUFDO1lBQ3pDLFVBQVUsQ0FBQyxrQkFBa0IsQ0FBQyxhQUFhLENBQUMsQ0FDL0MsR0FBRyxDQUFDLENBQUM7UUFDVixNQUFNLENBQUMsdUJBQXVCLEdBQUcsSUFBSSxDQUFDLEtBQUssQ0FBQyxpQkFBaUIsR0FBRyxtQkFBbUIsR0FBRyxtQkFBbUIsQ0FBQyxDQUFDO1FBRTNHLElBQU0sa0JBQWtCLEdBQUcsVUFBVSxDQUFDLGlCQUFpQixDQUFDLFdBQVcsQ0FBQyxDQUFDO1FBQ3JFLElBQU0saUJBQWlCLEdBQUcsVUFBVSxDQUFDLGlCQUFpQixDQUFDLFVBQVUsQ0FBQyxDQUFDO1FBRW5FLE1BQU0sQ0FBQyxlQUFlLEdBQUcsa0JBQWtCLENBQUM7UUFDNUMsTUFBTSxDQUFDLGNBQWMsR0FBRyxpQkFBaUIsQ0FBQztRQUMxQywwQ0FBMEM7UUFDMUMsTUFBTSxDQUFDLHNCQUFzQixHQUFHLFNBQVMsQ0FBQyxVQUFVLENBQUMsS0FBSyxHQUFHLEVBQUUsR0FBRyxrQkFBa0IsR0FBRyxDQUFDLENBQUM7UUFFekYsT0FBTyxNQUFNLENBQUM7SUFDbEIsQ0FBQztJQUVEOztPQUVHO0lBQ0ksNkRBQXlCLEdBQWhDO1FBQ0ksSUFBSSxXQUFXLENBQUM7UUFDaEIsSUFBSSxJQUFJLENBQUMsTUFBTSxDQUFDLFlBQVksRUFBRTtZQUMxQixXQUFXLEdBQUcsSUFBSSxDQUFDLE1BQU0sQ0FBQyxZQUFZLENBQUMsT0FBTyxDQUFDLGFBQWEsQ0FBQztZQUM3RCxxR0FBcUc7WUFDckcsSUFBSSxJQUFJLEVBQUUsRUFBRTtnQkFDUixJQUFJLENBQUMsTUFBTSxDQUFDLGVBQWUsQ0FBQyxTQUFTLEdBQUcsSUFBSSxDQUFDLE1BQU0sQ0FBQyx1QkFBdUIsQ0FBQyxJQUFJLENBQUMsTUFBTSxDQUFDLFlBQVksQ0FBQyxDQUFDO2FBQ3pHO1NBQ0o7YUFBTTtZQUNILFdBQVcsR0FBRyxJQUFJLENBQUMsTUFBTSxDQUFDLG1CQUFtQixFQUFFLENBQUM7U0FDbkQ7UUFDRCxPQUFPLFdBQVcsQ0FBQztJQUN2QixDQUFDO0lBRUQ7O09BRUc7SUFDSyxvREFBZ0IsR0FBeEIsVUFBeUIsU0FBb0I7UUFDekMsU0FBUyxDQUFDLGNBQWMsR0FBRyxDQUFDLENBQUMsU0FBUyxDQUFDLFFBQVEsQ0FBQyxHQUFHLEdBQUcsU0FBUyxDQUFDLGtCQUFrQixDQUFDLEdBQUc7WUFDbEYsU0FBUyxDQUFDLE1BQU0sQ0FBQyx1QkFBdUIsR0FBRyxTQUFTLENBQUMsWUFBWSxDQUFDLENBQUM7UUFDdkUsSUFBSSxDQUFDLGNBQWMsR0FBRyxTQUFTLENBQUMsY0FBYyxDQUFDO0lBQ25ELENBQUM7SUFFRDs7T0FFRztJQUNLLG9EQUFnQixHQUF4QixVQUF5QixTQUFvQjtRQUN6QyxTQUFTLENBQUMsZ0JBQWdCLEdBQUcsU0FBUyxDQUFDLE1BQU0sQ0FBQyxjQUFjLEdBQUcsU0FBUyxDQUFDLE1BQU0sQ0FBQyxlQUFlLENBQUM7UUFDaEcsSUFBSSxDQUFDLGNBQWMsR0FBRyxTQUFTLENBQUMsZ0JBQWdCLENBQUM7SUFDckQsQ0FBQztJQUNMLGdDQUFDO0FBQUQsQ0FBQyxBQS9MRCxDQUErQyx1QkFBdUIsR0ErTHJFIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHsgVmVydGljYWxBbGlnbm1lbnQsIEhvcml6b250YWxBbGlnbm1lbnQsIFBvc2l0aW9uU2V0dGluZ3MsIFNpemUsIFV0aWwsIENvbm5lY3RlZEZpdCAgfSBmcm9tICcuLi9zZXJ2aWNlcy9vdmVybGF5L3V0aWxpdGllcyc7XG5pbXBvcnQgeyBJUG9zaXRpb25TdHJhdGVneSB9IGZyb20gJy4uL3NlcnZpY2VzL292ZXJsYXkvcG9zaXRpb24nO1xuaW1wb3J0IHsgZmFkZU91dCwgZmFkZUluIH0gZnJvbSAnLi4vYW5pbWF0aW9ucy9tYWluJztcbmltcG9ydCB7IElneFNlbGVjdEJhc2UgfSBmcm9tICcuL3NlbGVjdC5jb21tb24nO1xuaW1wb3J0IHsgaXNJRSB9IGZyb20gJy4uL2NvcmUvdXRpbHMnO1xuaW1wb3J0IHsgQmFzZUZpdFBvc2l0aW9uU3RyYXRlZ3kgfSBmcm9tICcuLi9zZXJ2aWNlcy9vdmVybGF5L3Bvc2l0aW9uL2Jhc2UtZml0LXBvc2l0aW9uLXN0cmF0ZWd5JztcblxuLyoqIEBoaWRkZW4gQGludGVybmFsICovXG5leHBvcnQgY2xhc3MgU2VsZWN0UG9zaXRpb25pbmdTdHJhdGVneSBleHRlbmRzIEJhc2VGaXRQb3NpdGlvblN0cmF0ZWd5IGltcGxlbWVudHMgSVBvc2l0aW9uU3RyYXRlZ3kge1xuXG4gICAgcHJpdmF0ZSBfc2VsZWN0RGVmYXVsdFNldHRpbmdzID0ge1xuICAgICAgICBob3Jpem9udGFsRGlyZWN0aW9uOiBIb3Jpem9udGFsQWxpZ25tZW50LlJpZ2h0LFxuICAgICAgICB2ZXJ0aWNhbERpcmVjdGlvbjogVmVydGljYWxBbGlnbm1lbnQuQm90dG9tLFxuICAgICAgICBob3Jpem9udGFsU3RhcnRQb2ludDogSG9yaXpvbnRhbEFsaWdubWVudC5MZWZ0LFxuICAgICAgICB2ZXJ0aWNhbFN0YXJ0UG9pbnQ6IFZlcnRpY2FsQWxpZ25tZW50LlRvcCxcbiAgICAgICAgb3BlbkFuaW1hdGlvbjogZmFkZUluLFxuICAgICAgICBjbG9zZUFuaW1hdGlvbjogZmFkZU91dFxuICAgIH07XG5cbiAgICAvKiogQGluaGVyaXRkb2MgKi9cbiAgICBwdWJsaWMgc2V0dGluZ3M6IFBvc2l0aW9uU2V0dGluZ3M7XG5cbiAgICBjb25zdHJ1Y3RvcihwdWJsaWMgc2VsZWN0OiBJZ3hTZWxlY3RCYXNlLCBzZXR0aW5ncz86IFBvc2l0aW9uU2V0dGluZ3MpIHtcbiAgICAgICAgc3VwZXIoKTtcbiAgICAgICAgdGhpcy5zZXR0aW5ncyA9IE9iamVjdC5hc3NpZ24oe30sIHRoaXMuX3NlbGVjdERlZmF1bHRTZXR0aW5ncywgc2V0dGluZ3MpO1xuICAgIH1cblxuICAgIC8vIEdsb2JhbCB2YXJpYWJsZXMgcmVxdWlyZWQgZm9yIGNhc2VzIG9mICFpbml0aWFsQ2FsbCAocGFnZSBzY3JvbGwvb3ZlcmxheSByZXBvc2l0aW9uQWxsKVxuICAgIHByaXZhdGUgZ2xvYmFsX3lPZmZzZXQgPSAwO1xuICAgIHByaXZhdGUgZ2xvYmFsX3hPZmZzZXQgPSAwO1xuICAgIHByaXZhdGUgZ2xvYmFsX3N0eWxlczogU2VsZWN0U3R5bGVzID0ge307XG5cbiAgICAvKiogQGluaGVyaXRkb2MgKi9cbiAgICBwb3NpdGlvbihjb250ZW50RWxlbWVudDogSFRNTEVsZW1lbnQsIHNpemU6IFNpemUsIGRvY3VtZW50PzogRG9jdW1lbnQsIGluaXRpYWxDYWxsPzogYm9vbGVhbik6IHZvaWQge1xuICAgICAgICB0aGlzLnNlbGVjdC5zY3JvbGxDb250YWluZXIuc2Nyb2xsVG9wID0gMDtcbiAgICAgICAgY29uc3QgcmVjdHMgPSBzdXBlci5jYWxjdWxhdGVFbGVtZW50UmVjdGFuZ2xlcyhjb250ZW50RWxlbWVudCk7XG4gICAgICAgIC8vIHNlbGVjdEZpdCBvYmosIHRvIGJlIHVzZWQgZm9yIGJvdGggY2FzZXMgb2YgaW5pdGlhbENhbGwgYW5kICFpbml0aWFsQ2FsbChwYWdlIHNjcm9sbC9vdmVybGF5IHJlcG9zaXRpb25BbGwpXG4gICAgICAgIGNvbnN0IHNlbGVjdEZpdDogU2VsZWN0Rml0ID0ge1xuICAgICAgICAgICAgdmVydGljYWxPZmZzZXQ6IHRoaXMuZ2xvYmFsX3lPZmZzZXQsXG4gICAgICAgICAgICBob3Jpem9udGFsT2Zmc2V0OiB0aGlzLmdsb2JhbF94T2Zmc2V0LFxuICAgICAgICAgICAgdGFyZ2V0UmVjdDogcmVjdHMudGFyZ2V0UmVjdCxcbiAgICAgICAgICAgIGNvbnRlbnRFbGVtZW50UmVjdDogcmVjdHMuZWxlbWVudFJlY3QsXG4gICAgICAgICAgICBzdHlsZXM6IHRoaXMuZ2xvYmFsX3N0eWxlcyxcbiAgICAgICAgICAgIHNjcm9sbENvbnRhaW5lcjogdGhpcy5zZWxlY3Quc2Nyb2xsQ29udGFpbmVyLFxuICAgICAgICAgICAgc2Nyb2xsQ29udGFpbmVyUmVjdDogdGhpcy5zZWxlY3Quc2Nyb2xsQ29udGFpbmVyLmdldEJvdW5kaW5nQ2xpZW50UmVjdCgpXG4gICAgICAgIH07XG5cbiAgICAgICAgaWYgKGluaXRpYWxDYWxsKSB7XG4gICAgICAgICAgICAvLyBGaWxsIGluIHRoZSByZXF1aXJlZCBzZWxlY3RGaXQgb2JqZWN0IHByb3BlcnRpZXMuXG4gICAgICAgICAgICBzZWxlY3RGaXQudmlld1BvcnRSZWN0ID0gVXRpbC5nZXRWaWV3cG9ydFJlY3QoZG9jdW1lbnQpO1xuICAgICAgICAgICAgc2VsZWN0Rml0Lml0ZW1FbGVtZW50ID0gdGhpcy5nZXRJbnRlcmFjdGlvbkl0ZW1FbGVtZW50KCk7XG4gICAgICAgICAgICBzZWxlY3RGaXQuaXRlbVJlY3QgPSBzZWxlY3RGaXQuaXRlbUVsZW1lbnQuZ2V0Qm91bmRpbmdDbGllbnRSZWN0KCk7XG5cbiAgICAgICAgICAgIC8vIENhbGN1bGF0ZSBpbnB1dCBhbmQgc2VsZWN0ZWQgaXRlbSBlbGVtZW50cyBzdHlsZSByZWxhdGVkIHZhcmlhYmxlc1xuICAgICAgICAgICAgc2VsZWN0Rml0LnN0eWxlcyA9IHRoaXMuY2FsY3VsYXRlU3R5bGVzKHNlbGVjdEZpdCk7XG5cbiAgICAgICAgICAgIHNlbGVjdEZpdC5zY3JvbGxBbW91bnQgPSB0aGlzLmNhbGN1bGF0ZVNjcm9sbEFtb3VudChzZWxlY3RGaXQpO1xuICAgICAgICAgICAgLy8gQ2FsY3VsYXRlIGhvdyBtdWNoIHRvIG9mZnNldCB0aGUgb3ZlcmxheSBjb250YWluZXIuXG4gICAgICAgICAgICB0aGlzLmNhbGN1bGF0ZVlvZmZzZXQoc2VsZWN0Rml0KTtcbiAgICAgICAgICAgIHRoaXMuY2FsY3VsYXRlWG9mZnNldChzZWxlY3RGaXQpO1xuXG4gICAgICAgICAgICBzdXBlci51cGRhdGVWaWV3UG9ydEZpdChzZWxlY3RGaXQpO1xuICAgICAgICAgICAgLy8gY29udGFpbmVyIGRvZXMgbm90IGZpdCBpbiB2aWV3UG9ydCBhbmQgaXMgb3V0IG9uIFRvcCBvciBCb3R0b21cbiAgICAgICAgICAgIGlmIChzZWxlY3RGaXQuZml0VmVydGljYWwuYmFjayA8IDAgfHwgc2VsZWN0Rml0LmZpdFZlcnRpY2FsLmZvcndhcmQgPCAwICkge1xuICAgICAgICAgICAgICAgIHRoaXMuZml0SW5WaWV3cG9ydChjb250ZW50RWxlbWVudCwgc2VsZWN0Rml0KTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgICAgIHRoaXMuc2VsZWN0LnNjcm9sbENvbnRhaW5lci5zY3JvbGxUb3AgPSBzZWxlY3RGaXQuc2Nyb2xsQW1vdW50O1xuICAgICAgICB9XG4gICAgICAgIHRoaXMuc2V0U3R5bGVzKGNvbnRlbnRFbGVtZW50LCBzZWxlY3RGaXQpO1xuICAgIH1cblxuICAgIC8qKlxuICAgICAqIENhbGN1bGF0ZSBzZWxlY3RlZCBpdGVtIHNjcm9sbCBwb3NpdGlvbi5cbiAgICAgKi9cbiAgICBwcml2YXRlIGNhbGN1bGF0ZVNjcm9sbEFtb3VudChzZWxlY3RGaXQ6IFNlbGVjdEZpdCk6IG51bWJlciB7XG4gICAgICAgIGNvbnN0IGl0ZW1FbGVtZW50UmVjdCA9IHNlbGVjdEZpdC5pdGVtUmVjdDtcbiAgICAgICAgY29uc3Qgc2Nyb2xsQ29udGFpbmVyID0gc2VsZWN0Rml0LnNjcm9sbENvbnRhaW5lcjtcbiAgICAgICAgY29uc3Qgc2Nyb2xsQ29udGFpbmVyUmVjdCA9IHNlbGVjdEZpdC5zY3JvbGxDb250YWluZXJSZWN0O1xuICAgICAgICBjb25zdCBzY3JvbGxEZWx0YSA9IHNjcm9sbENvbnRhaW5lclJlY3QudG9wIC0gaXRlbUVsZW1lbnRSZWN0LnRvcDtcbiAgICAgICAgbGV0IHNjcm9sbFBvc2l0aW9uID0gc2Nyb2xsQ29udGFpbmVyLnNjcm9sbFRvcCAtIHNjcm9sbERlbHRhO1xuXG4gICAgICAgIGNvbnN0IGRyb3BEb3duSGVpZ2h0ID0gc2Nyb2xsQ29udGFpbmVyLmNsaWVudEhlaWdodDtcbiAgICAgICAgc2Nyb2xsUG9zaXRpb24gLT0gZHJvcERvd25IZWlnaHQgLyAyO1xuICAgICAgICBzY3JvbGxQb3NpdGlvbiArPSBpdGVtRWxlbWVudFJlY3QuaGVpZ2h0IC8gMjtcblxuICAgICAgICByZXR1cm4gTWF0aC5yb3VuZChNYXRoLm1pbihNYXRoLm1heCgwLCBzY3JvbGxQb3NpdGlvbiksIHNjcm9sbENvbnRhaW5lci5zY3JvbGxIZWlnaHQgLSBzY3JvbGxDb250YWluZXJSZWN0LmhlaWdodCkpO1xuICAgIH1cblxuICAgIC8qKlxuICAgICAqIFBvc2l0aW9uIHRoZSBpdGVtcyBvdXRlciBjb250YWluZXIgc28gc2VsZWN0ZWQgaXRlbSB0ZXh0IGlzIHBvc2l0aW9uZWQgb3ZlciBpbnB1dCB0ZXh0IGFuZCBpZiBoZWFkZXJcbiAgICAgKiBBbmQvT1IgZm9vdGVyIC0gYm90aCBoZWFkZXIvZm9vdGVyIGFyZSB2aXNpYmxlXG4gICAgICogQHBhcmFtIHNlbGVjdEZpdCBzZWxlY3RGaXQgdG8gdXNlIGZvciBjb21wdXRhdGlvbi5cbiAgICAgKi9cbiAgICBwcm90ZWN0ZWQgZml0SW5WaWV3cG9ydChjb250ZW50RWxlbWVudDogSFRNTEVsZW1lbnQsIHNlbGVjdEZpdDogU2VsZWN0Rml0KSB7XG4gICAgICAgIGNvbnN0IGZvb3RlciA9IHNlbGVjdEZpdC5zY3JvbGxDb250YWluZXJSZWN0LmJvdHRvbSAtIHNlbGVjdEZpdC5jb250ZW50RWxlbWVudFJlY3QuYm90dG9tO1xuICAgICAgICBjb25zdCBoZWFkZXIgPSBzZWxlY3RGaXQuc2Nyb2xsQ29udGFpbmVyUmVjdC50b3AgLSBzZWxlY3RGaXQuY29udGVudEVsZW1lbnRSZWN0LnRvcDtcbiAgICAgICAgY29uc3QgbGFzdEl0ZW1GaXRTaXplID0gc2VsZWN0Rml0LnRhcmdldFJlY3QuYm90dG9tICsgc2VsZWN0Rml0LnN0eWxlcy5pdGVtVGV4dFRvSW5wdXRUZXh0RGlmZiAtIGZvb3RlcjtcbiAgICAgICAgY29uc3QgZmlyc3RJdGVtRml0U2l6ZSA9IHNlbGVjdEZpdC50YXJnZXRSZWN0LnRvcCAtIHNlbGVjdEZpdC5zdHlsZXMuaXRlbVRleHRUb0lucHV0VGV4dERpZmYgLSBoZWFkZXI7XG4gICAgICAgIC8vIG91dCBvZiB2aWV3UG9ydCBvbiBUb3BcbiAgICAgICAgaWYgKHNlbGVjdEZpdC5maXRWZXJ0aWNhbC5iYWNrIDwgMCkge1xuICAgICAgICAgICAgY29uc3QgcG9zc2libGVTY3JvbGxBbW91bnQgPSBzZWxlY3RGaXQuc2Nyb2xsQ29udGFpbmVyLnNjcm9sbEhlaWdodCAtXG4gICAgICAgICAgICAgICAgc2VsZWN0Rml0LnNjcm9sbENvbnRhaW5lclJlY3QuaGVpZ2h0IC0gc2VsZWN0Rml0LnNjcm9sbEFtb3VudDtcbiAgICAgICAgICAgIGlmIChwb3NzaWJsZVNjcm9sbEFtb3VudCArIHNlbGVjdEZpdC5maXRWZXJ0aWNhbC5iYWNrID4gMCAmJiBmaXJzdEl0ZW1GaXRTaXplID4gc2VsZWN0Rml0LnZpZXdQb3J0UmVjdC50b3ApIHtcbiAgICAgICAgICAgICAgICBzZWxlY3RGaXQuc2Nyb2xsQW1vdW50IC09IHNlbGVjdEZpdC5maXRWZXJ0aWNhbC5iYWNrO1xuICAgICAgICAgICAgICAgIHNlbGVjdEZpdC52ZXJ0aWNhbE9mZnNldCAtPSBzZWxlY3RGaXQuZml0VmVydGljYWwuYmFjaztcbiAgICAgICAgICAgICAgICB0aGlzLmdsb2JhbF95T2Zmc2V0ID0gc2VsZWN0Rml0LnZlcnRpY2FsT2Zmc2V0O1xuICAgICAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgICAgICBzZWxlY3RGaXQudmVydGljYWxPZmZzZXQgPSAwIDtcbiAgICAgICAgICAgICAgICB0aGlzLmdsb2JhbF95T2Zmc2V0ID0gMDtcbiAgICAgICAgICAgIH1cbiAgICAgICAgLy8gb3V0IG9mIHZpZXdQb3J0IG9uIEJvdHRvbVxuICAgICAgICB9IGVsc2UgaWYgKHNlbGVjdEZpdC5maXRWZXJ0aWNhbC5mb3J3YXJkIDwgMCkge1xuICAgICAgICAgICAgaWYgKHNlbGVjdEZpdC5zY3JvbGxBbW91bnQgKyBzZWxlY3RGaXQuZml0VmVydGljYWwuZm9yd2FyZCA+IDAgJiYgbGFzdEl0ZW1GaXRTaXplIDwgc2VsZWN0Rml0LnZpZXdQb3J0UmVjdC5ib3R0b20pIHtcbiAgICAgICAgICAgICAgICBzZWxlY3RGaXQuc2Nyb2xsQW1vdW50ICs9IHNlbGVjdEZpdC5maXRWZXJ0aWNhbC5mb3J3YXJkO1xuICAgICAgICAgICAgICAgIHNlbGVjdEZpdC52ZXJ0aWNhbE9mZnNldCArPSBzZWxlY3RGaXQuZml0VmVydGljYWwuZm9yd2FyZDtcbiAgICAgICAgICAgICAgICB0aGlzLmdsb2JhbF95T2Zmc2V0ID0gc2VsZWN0Rml0LnZlcnRpY2FsT2Zmc2V0O1xuICAgICAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgICAgICBzZWxlY3RGaXQudmVydGljYWxPZmZzZXQgPSAtc2VsZWN0Rml0LmNvbnRlbnRFbGVtZW50UmVjdC5oZWlnaHQgKyBzZWxlY3RGaXQudGFyZ2V0UmVjdC5oZWlnaHQ7XG4gICAgICAgICAgICAgICAgdGhpcy5nbG9iYWxfeU9mZnNldCA9IHNlbGVjdEZpdC52ZXJ0aWNhbE9mZnNldDtcbiAgICAgICAgICAgIH1cbiAgICAgICAgfVxuICAgIH1cblxuICAgIC8qKlxuICAgICAqIFNldHMgZWxlbWVudCdzIHN0eWxlIHdoaWNoIGVmZmVjdGl2ZWx5IHBvc2l0aW9ucyB0aGUgcHJvdmlkZWQgZWxlbWVudFxuICAgICAqIEBwYXJhbSBlbGVtZW50IEVsZW1lbnQgdG8gcG9zaXRpb25cbiAgICAgKiBAcGFyYW0gc2VsZWN0Rml0IHNlbGVjdEZpdCB0byB1c2UgZm9yIGNvbXB1dGF0aW9uLlxuICAgICAqIEBwYXJhbSBpbml0aWFsQ2FsbCBzaG91bGQgYmUgdHJ1ZSBpZiB0aGlzIGlzIHRoZSBpbml0aWFsIGNhbGwgdG8gdGhlIHBvc2l0aW9uIG1ldGhvZCBjYWxsaW5nIHNldFN0eWxlc1xuICAgICAqL1xuICAgIHByb3RlY3RlZCBzZXRTdHlsZXMoY29udGVudEVsZW1lbnQ6IEhUTUxFbGVtZW50LCBzZWxlY3RGaXQ6IFNlbGVjdEZpdCkge1xuICAgICAgICBzdXBlci5zZXRTdHlsZShjb250ZW50RWxlbWVudCwgc2VsZWN0Rml0LnRhcmdldFJlY3QsIHNlbGVjdEZpdC5jb250ZW50RWxlbWVudFJlY3QsIHNlbGVjdEZpdCk7XG4gICAgICAgIGNvbnRlbnRFbGVtZW50LnN0eWxlLndpZHRoID0gYCR7c2VsZWN0Rml0LnN0eWxlcy5jb250ZW50RWxlbWVudE5ld1dpZHRofXB4YDsgLy8gbWFuYWdlIGNvbnRhaW5lciBiYXNlZCBvbiBwYWRkaW5ncz9cbiAgICAgICAgdGhpcy5nbG9iYWxfc3R5bGVzLmNvbnRlbnRFbGVtZW50TmV3V2lkdGggPSBzZWxlY3RGaXQuc3R5bGVzLmNvbnRlbnRFbGVtZW50TmV3V2lkdGg7XG4gICAgfVxuXG4gICAgLyoqXG4gICAgICogQ2FsY3VsYXRlIHRoZSBuZWNlc3NhcnkgaW5wdXQgYW5kIHNlbGVjdGVkIGl0ZW0gc3R5bGVzIHRvIGJlIHVzZWQgZm9yIHBvc2l0aW9uaW5nIGl0ZW0gdGV4dCBvdmVyIGlucHV0IHRleHQuXG4gICAgICogQ2FsY3VsYXRlICYgU2V0IGRlZmF1bHQgaXRlbXMgY29udGFpbmVyIHdpZHRoLlxuICAgICAqIEBwYXJhbSBzZWxlY3RGaXQgc2VsZWN0Rml0IHRvIHVzZSBmb3IgY29tcHV0YXRpb24uXG4gICAgICovXG4gICAgcHJpdmF0ZSBjYWxjdWxhdGVTdHlsZXMoc2VsZWN0Rml0OiBTZWxlY3RGaXQpOiBTZWxlY3RTdHlsZXMgIHtcbiAgICAgICAgY29uc3Qgc3R5bGVzOiBTZWxlY3RTdHlsZXMgPSB7fTtcbiAgICAgICAgY29uc3QgaW5wdXRFbGVtZW50U3R5bGVzID0gd2luZG93LmdldENvbXB1dGVkU3R5bGUodGhpcy5zZXR0aW5ncy50YXJnZXQgYXMgRWxlbWVudCk7XG4gICAgICAgIGNvbnN0IGl0ZW1FbGVtZW50U3R5bGVzID0gd2luZG93LmdldENvbXB1dGVkU3R5bGUoc2VsZWN0Rml0Lml0ZW1FbGVtZW50KTtcbiAgICAgICAgY29uc3QgbnVtZXJpY0lucHV0Rm9udFNpemUgPSBwYXJzZUZsb2F0KGlucHV0RWxlbWVudFN0eWxlcy5mb250U2l6ZSk7XG4gICAgICAgIGNvbnN0IG51bWVyaWNJdGVtRm9udFNpemUgPSBwYXJzZUZsb2F0KGl0ZW1FbGVtZW50U3R5bGVzLmZvbnRTaXplKTtcbiAgICAgICAgY29uc3QgaW5wdXRUZXh0VG9JbnB1dFRvcCA9IChzZWxlY3RGaXQudGFyZ2V0UmVjdC5ib3R0b20gLSBzZWxlY3RGaXQudGFyZ2V0UmVjdC50b3AgLSBudW1lcmljSW5wdXRGb250U2l6ZSkgLyAyO1xuICAgICAgICBjb25zdCBpdGVtVGV4dFRvSXRlbVRvcCA9IChzZWxlY3RGaXQuaXRlbVJlY3QuaGVpZ2h0IC0gbnVtZXJpY0l0ZW1Gb250U2l6ZSkgLyAyO1xuICAgICAgICAgLy8gQWRqdXN0IGZvciBpbnB1dCB0b3AgcGFkZGluZ1xuICAgICAgICBjb25zdCBuZWdhdGVJbnB1dFBhZGRpbmdzID0gKFxuICAgICAgICAgICAgICAgIHBhcnNlRmxvYXQoaW5wdXRFbGVtZW50U3R5bGVzLnBhZGRpbmdUb3ApIC1cbiAgICAgICAgICAgICAgICBwYXJzZUZsb2F0KGlucHV0RWxlbWVudFN0eWxlcy5wYWRkaW5nQm90dG9tKVxuICAgICAgICAgICAgKSAvIDI7XG4gICAgICAgIHN0eWxlcy5pdGVtVGV4dFRvSW5wdXRUZXh0RGlmZiA9IE1hdGgucm91bmQoaXRlbVRleHRUb0l0ZW1Ub3AgLSBpbnB1dFRleHRUb0lucHV0VG9wICsgbmVnYXRlSW5wdXRQYWRkaW5ncyk7XG5cbiAgICAgICAgY29uc3QgbnVtZXJpY0xlZnRQYWRkaW5nID0gcGFyc2VGbG9hdChpdGVtRWxlbWVudFN0eWxlcy5wYWRkaW5nTGVmdCk7XG4gICAgICAgIGNvbnN0IG51bWVyaWNUZXh0SW5kZW50ID0gcGFyc2VGbG9hdChpdGVtRWxlbWVudFN0eWxlcy50ZXh0SW5kZW50KTtcblxuICAgICAgICBzdHlsZXMuaXRlbVRleHRQYWRkaW5nID0gbnVtZXJpY0xlZnRQYWRkaW5nO1xuICAgICAgICBzdHlsZXMuaXRlbVRleHRJbmRlbnQgPSBudW1lcmljVGV4dEluZGVudDtcbiAgICAgICAgLy8gMjQgaXMgdGhlIGlucHV0J3MgdG9nZ2xlIGRkbCBpY29uIHdpZHRoXG4gICAgICAgIHN0eWxlcy5jb250ZW50RWxlbWVudE5ld1dpZHRoID0gc2VsZWN0Rml0LnRhcmdldFJlY3Qud2lkdGggKyAyNCArIG51bWVyaWNMZWZ0UGFkZGluZyAqIDI7XG5cbiAgICAgICAgcmV0dXJuIHN0eWxlcztcbiAgICB9XG5cbiAgICAvKipcbiAgICAgKiBPYnRhaW4gdGhlIHNlbGVjdGVkIGl0ZW0gaWYgdGhlcmUgaXMgc3VjaCBvbmUgb3Igb3RoZXJ3aXNlIHVzZSB0aGUgZmlyc3Qgb25lXG4gICAgICovXG4gICAgcHVibGljIGdldEludGVyYWN0aW9uSXRlbUVsZW1lbnQoKTogSFRNTEVsZW1lbnQge1xuICAgICAgICBsZXQgaXRlbUVsZW1lbnQ7XG4gICAgICAgIGlmICh0aGlzLnNlbGVjdC5zZWxlY3RlZEl0ZW0pIHtcbiAgICAgICAgICAgIGl0ZW1FbGVtZW50ID0gdGhpcy5zZWxlY3Quc2VsZWN0ZWRJdGVtLmVsZW1lbnQubmF0aXZlRWxlbWVudDtcbiAgICAgICAgICAgIC8vIEQuUC4gRmViIDIyIDIwMTksICMzOTIxIEZvcmNlIGl0ZW0gc2Nyb2xsIGJlZm9yZSBtZWFzdXJpbmcgaW4gSUUxMSwgZHVlIHRvIGJhc2Ugc2Nyb2xsVG9JdGVtIGRlbGF5XG4gICAgICAgICAgICBpZiAoaXNJRSgpKSB7XG4gICAgICAgICAgICAgICAgdGhpcy5zZWxlY3Quc2Nyb2xsQ29udGFpbmVyLnNjcm9sbFRvcCA9IHRoaXMuc2VsZWN0LmNhbGN1bGF0ZVNjcm9sbFBvc2l0aW9uKHRoaXMuc2VsZWN0LnNlbGVjdGVkSXRlbSk7XG4gICAgICAgICAgICB9XG4gICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICBpdGVtRWxlbWVudCA9IHRoaXMuc2VsZWN0LmdldEZpcnN0SXRlbUVsZW1lbnQoKTtcbiAgICAgICAgfVxuICAgICAgICByZXR1cm4gaXRlbUVsZW1lbnQ7XG4gICAgfVxuXG4gICAgLyoqXG4gICAgICogQ2FsY3VsYXRlIGhvdyBtdWNoIHRvIG9mZnNldCB0aGUgb3ZlcmxheSBjb250YWluZXIgZm9yIFktYXhpcy5cbiAgICAgKi9cbiAgICBwcml2YXRlIGNhbGN1bGF0ZVlvZmZzZXQoc2VsZWN0Rml0OiBTZWxlY3RGaXQpIHtcbiAgICAgICAgc2VsZWN0Rml0LnZlcnRpY2FsT2Zmc2V0ID0gLShzZWxlY3RGaXQuaXRlbVJlY3QudG9wIC0gc2VsZWN0Rml0LmNvbnRlbnRFbGVtZW50UmVjdC50b3AgK1xuICAgICAgICAgICAgc2VsZWN0Rml0LnN0eWxlcy5pdGVtVGV4dFRvSW5wdXRUZXh0RGlmZiAtIHNlbGVjdEZpdC5zY3JvbGxBbW91bnQpO1xuICAgICAgICB0aGlzLmdsb2JhbF95T2Zmc2V0ID0gc2VsZWN0Rml0LnZlcnRpY2FsT2Zmc2V0O1xuICAgIH1cblxuICAgIC8qKlxuICAgICAqIENhbGN1bGF0ZSBob3cgbXVjaCB0byBvZmZzZXQgdGhlIG92ZXJsYXkgY29udGFpbmVyIGZvciBYLWF4aXMuXG4gICAgICovXG4gICAgcHJpdmF0ZSBjYWxjdWxhdGVYb2Zmc2V0KHNlbGVjdEZpdDogU2VsZWN0Rml0KSB7XG4gICAgICAgIHNlbGVjdEZpdC5ob3Jpem9udGFsT2Zmc2V0ID0gc2VsZWN0Rml0LnN0eWxlcy5pdGVtVGV4dEluZGVudCAtIHNlbGVjdEZpdC5zdHlsZXMuaXRlbVRleHRQYWRkaW5nO1xuICAgICAgICB0aGlzLmdsb2JhbF94T2Zmc2V0ID0gc2VsZWN0Rml0Lmhvcml6b250YWxPZmZzZXQ7XG4gICAgfVxufVxuXG4vKiogQGhpZGRlbiAqL1xuZXhwb3J0IGludGVyZmFjZSBTZWxlY3RGaXQgZXh0ZW5kcyBDb25uZWN0ZWRGaXQge1xuICAgIGl0ZW1FbGVtZW50PzogSFRNTEVsZW1lbnQ7XG4gICAgc2Nyb2xsQ29udGFpbmVyOiBIVE1MRWxlbWVudDtcbiAgICBzY3JvbGxDb250YWluZXJSZWN0OiBDbGllbnRSZWN0O1xuICAgIGl0ZW1SZWN0PzogQ2xpZW50UmVjdDtcbiAgICBzdHlsZXM/OiBTZWxlY3RTdHlsZXM7XG4gICAgc2Nyb2xsQW1vdW50PzogbnVtYmVyO1xufVxuXG4vKiogQGhpZGRlbiAqL1xuZXhwb3J0IGludGVyZmFjZSBTZWxlY3RTdHlsZXMge1xuICAgIGl0ZW1UZXh0UGFkZGluZz86IG51bWJlcjtcbiAgICBpdGVtVGV4dEluZGVudD86IG51bWJlcjtcbiAgICBpdGVtVGV4dFRvSW5wdXRUZXh0RGlmZj86IG51bWJlcjtcbiAgICBjb250ZW50RWxlbWVudE5ld1dpZHRoPzogbnVtYmVyO1xuICAgIG51bWVyaWNMZWZ0UGFkZGluZz86IG51bWJlcjtcbn1cbiJdfQ==