import { __decorate, __extends, __read, __spread, __values } from "tslib";
import { GridBaseAPIService } from '../api.service';
import { DataUtil } from '../../data-operations/data-util';
import { cloneArray } from '../../core/utils';
import { Injectable } from '@angular/core';
var IgxGridAPIService = /** @class */ (function (_super) {
    __extends(IgxGridAPIService, _super);
    function IgxGridAPIService() {
        return _super !== null && _super.apply(this, arguments) || this;
    }
    IgxGridAPIService.prototype.groupBy = function (expression) {
        var groupingState = cloneArray(this.grid.groupingExpressions);
        var sortingState = cloneArray(this.grid.sortingExpressions);
        this.prepare_sorting_expression([sortingState, groupingState], expression);
        this.grid.groupingExpressions = groupingState;
        this.arrange_sorting_expressions();
    };
    IgxGridAPIService.prototype.groupBy_multiple = function (expressions) {
        var e_1, _a;
        var groupingState = cloneArray(this.grid.groupingExpressions);
        var sortingState = cloneArray(this.grid.sortingExpressions);
        try {
            for (var expressions_1 = __values(expressions), expressions_1_1 = expressions_1.next(); !expressions_1_1.done; expressions_1_1 = expressions_1.next()) {
                var each = expressions_1_1.value;
                this.prepare_sorting_expression([sortingState, groupingState], each);
            }
        }
        catch (e_1_1) { e_1 = { error: e_1_1 }; }
        finally {
            try {
                if (expressions_1_1 && !expressions_1_1.done && (_a = expressions_1.return)) _a.call(expressions_1);
            }
            finally { if (e_1) throw e_1.error; }
        }
        this.grid.groupingExpressions = groupingState;
        this.arrange_sorting_expressions();
    };
    IgxGridAPIService.prototype.clear_groupby = function (name) {
        var e_2, _a;
        var _this = this;
        var groupingState = cloneArray(this.grid.groupingExpressions);
        var sortingState = cloneArray(this.grid.sortingExpressions);
        if (name) {
            var names_1 = typeof name === 'string' ? [name] : name;
            var groupedCols = groupingState.filter(function (state) { return names_1.indexOf(state.fieldName) < 0; });
            var newSortingExpr = sortingState.filter(function (state) { return names_1.indexOf(state.fieldName) < 0; });
            this.grid.groupingExpressions = groupedCols;
            this.grid.sortingExpressions = newSortingExpr;
            names_1.forEach(function (colName) {
                var grExprIndex = groupingState.findIndex(function (exp) { return exp.fieldName === colName; });
                var grpExpandState = _this.grid.groupingExpansionState;
                /* remove expansion states related to the cleared group
                   and all with deeper hierarchy than the cleared group */
                var newExpandState = grpExpandState.filter(function (val) {
                    return val.hierarchy && val.hierarchy.length <= grExprIndex;
                });
                /* Do not set the new instance produced by filter
                    when there are no differences between expansion states */
                if (newExpandState.length !== grpExpandState.length) {
                    _this.grid.groupingExpansionState = newExpandState;
                }
            });
        }
        else {
            // clear all
            this.grid.groupingExpressions = [];
            this.grid.groupingExpansionState = [];
            var _loop_1 = function (grExpr) {
                var sortExprIndex = sortingState.findIndex(function (exp) { return exp.fieldName === grExpr.fieldName; });
                if (sortExprIndex > -1) {
                    sortingState.splice(sortExprIndex, 1);
                }
            };
            try {
                for (var groupingState_1 = __values(groupingState), groupingState_1_1 = groupingState_1.next(); !groupingState_1_1.done; groupingState_1_1 = groupingState_1.next()) {
                    var grExpr = groupingState_1_1.value;
                    _loop_1(grExpr);
                }
            }
            catch (e_2_1) { e_2 = { error: e_2_1 }; }
            finally {
                try {
                    if (groupingState_1_1 && !groupingState_1_1.done && (_a = groupingState_1.return)) _a.call(groupingState_1);
                }
                finally { if (e_2) throw e_2.error; }
            }
            this.grid.sortingExpressions = sortingState;
        }
    };
    IgxGridAPIService.prototype.groupBy_get_expanded_for_group = function (groupRow) {
        var grState = this.grid.groupingExpansionState;
        var hierarchy = DataUtil.getHierarchy(groupRow);
        return grState.find(function (state) {
            return DataUtil.isHierarchyMatch(state.hierarchy || [{ fieldName: groupRow.expression.fieldName, value: groupRow.value }], hierarchy);
        });
    };
    IgxGridAPIService.prototype.groupBy_is_row_in_group = function (groupRow, rowID) {
        var grid = this.grid;
        var rowInGroup = false;
        groupRow.records.forEach(function (row) {
            if (grid.primaryKey ? row[grid.primaryKey] === rowID : row === rowID) {
                rowInGroup = true;
            }
        });
        return rowInGroup;
    };
    IgxGridAPIService.prototype.groupBy_toggle_group = function (groupRow) {
        var grid = this.grid;
        if (grid.crudService.isInEditMode) {
            grid.endEdit(true);
        }
        var expansionState = grid.groupingExpansionState;
        var state = this.groupBy_get_expanded_for_group(groupRow);
        if (state) {
            state.expanded = !state.expanded;
        }
        else {
            expansionState.push({
                expanded: !grid.groupsExpanded,
                hierarchy: DataUtil.getHierarchy(groupRow)
            });
        }
        this.grid.groupingExpansionState = __spread(expansionState);
        if (grid.rowEditable) {
            grid.repositionRowEditingOverlay(grid.rowInEditMode);
        }
    };
    IgxGridAPIService.prototype.groupBy_fully_expand_group = function (groupRow) {
        var state = this.groupBy_get_expanded_for_group(groupRow);
        var expanded = state ? state.expanded : this.grid.groupsExpanded;
        if (!expanded) {
            this.groupBy_toggle_group(groupRow);
        }
        if (groupRow.groupParent) {
            this.groupBy_fully_expand_group(groupRow.groupParent);
        }
    };
    IgxGridAPIService.prototype.remove_grouping_expression = function (fieldName) {
        var groupingExpressions = this.grid.groupingExpressions;
        var index = groupingExpressions.findIndex(function (expr) { return expr.fieldName === fieldName; });
        if (index !== -1) {
            groupingExpressions.splice(index, 1);
        }
    };
    IgxGridAPIService.prototype.arrange_sorting_expressions = function () {
        var groupingState = this.grid.groupingExpressions;
        this.grid.sortingExpressions.sort(function (a, b) {
            var groupExprA = groupingState.find(function (expr) { return expr.fieldName === a.fieldName; });
            var groupExprB = groupingState.find(function (expr) { return expr.fieldName === b.fieldName; });
            if (groupExprA && groupExprB) {
                return groupingState.indexOf(groupExprA) > groupingState.indexOf(groupExprB) ? 1 : -1;
            }
            else if (groupExprA) {
                return -1;
            }
            else if (groupExprB) {
                return 1;
            }
            else {
                return 0;
            }
        });
    };
    IgxGridAPIService.prototype.get_groupBy_record_id = function (gRow) {
        var recordId = '{ ';
        var hierrarchy = DataUtil.getHierarchy(gRow);
        for (var i = 0; i < hierrarchy.length; i++) {
            var groupByKey = hierrarchy[i];
            recordId += "'" + groupByKey.fieldName + "': '" + groupByKey.value + "'";
            if (i < hierrarchy.length - 1) {
                recordId += ', ';
            }
        }
        recordId += ' }';
        return recordId;
    };
    IgxGridAPIService = __decorate([
        Injectable()
    ], IgxGridAPIService);
    return IgxGridAPIService;
}(GridBaseAPIService));
export { IgxGridAPIService };
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiZ3JpZC1hcGkuc2VydmljZS5qcyIsInNvdXJjZVJvb3QiOiJuZzovL2lnbml0ZXVpLWFuZ3VsYXIvIiwic291cmNlcyI6WyJsaWIvZ3JpZHMvZ3JpZC9ncmlkLWFwaS5zZXJ2aWNlLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiI7QUFBQSxPQUFPLEVBQUUsa0JBQWtCLEVBQUUsTUFBTSxnQkFBZ0IsQ0FBQztBQUlwRCxPQUFPLEVBQUUsUUFBUSxFQUFFLE1BQU0saUNBQWlDLENBQUM7QUFDM0QsT0FBTyxFQUFFLFVBQVUsRUFBRSxNQUFNLGtCQUFrQixDQUFDO0FBRTlDLE9BQU8sRUFBRSxVQUFVLEVBQUUsTUFBTSxlQUFlLENBQUM7QUFHM0M7SUFBdUMscUNBQW9DO0lBQTNFOztJQXlKQSxDQUFDO0lBdkpVLG1DQUFPLEdBQWQsVUFBZSxVQUErQjtRQUMxQyxJQUFNLGFBQWEsR0FBRyxVQUFVLENBQUMsSUFBSSxDQUFDLElBQUksQ0FBQyxtQkFBbUIsQ0FBQyxDQUFDO1FBQ2hFLElBQU0sWUFBWSxHQUFHLFVBQVUsQ0FBQyxJQUFJLENBQUMsSUFBSSxDQUFDLGtCQUFrQixDQUFDLENBQUM7UUFDOUQsSUFBSSxDQUFDLDBCQUEwQixDQUFDLENBQUMsWUFBWSxFQUFFLGFBQWEsQ0FBQyxFQUFFLFVBQVUsQ0FBQyxDQUFDO1FBQzNFLElBQUksQ0FBQyxJQUFJLENBQUMsbUJBQW1CLEdBQUcsYUFBYSxDQUFDO1FBQzlDLElBQUksQ0FBQywyQkFBMkIsRUFBRSxDQUFDO0lBQ3ZDLENBQUM7SUFFTSw0Q0FBZ0IsR0FBdkIsVUFBd0IsV0FBa0M7O1FBQ3RELElBQU0sYUFBYSxHQUFHLFVBQVUsQ0FBQyxJQUFJLENBQUMsSUFBSSxDQUFDLG1CQUFtQixDQUFDLENBQUM7UUFDaEUsSUFBTSxZQUFZLEdBQUcsVUFBVSxDQUFDLElBQUksQ0FBQyxJQUFJLENBQUMsa0JBQWtCLENBQUMsQ0FBQzs7WUFFOUQsS0FBbUIsSUFBQSxnQkFBQSxTQUFBLFdBQVcsQ0FBQSx3Q0FB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QUMsQ0FBQzthQUNaO2lCQUFNO2dCQUNILE9BQU8sQ0FBQyxDQUFDO2FBQ1o7UUFDTCxDQUFDLENBQUMsQ0FBQztJQUNQLENBQUM7SUFFTSxpREFBcUIsR0FBNUIsVUFBNkIsSUFBb0I7UUFDN0MsSUFBSSxRQUFRLEdBQUcsSUFBSSxDQUFDO1FBQ3BCLElBQU0sVUFBVSxHQUFHLFFBQVEsQ0FBQyxZQUFZLENBQUMsSUFBSSxDQUFDLENBQUM7UUFFL0MsS0FBSyxJQUFJLENBQUMsR0FBRyxDQUFDLEVBQUUsQ0FBQyxHQUFHLFVBQVUsQ0FBQyxNQUFNLEVBQUUsQ0FBQyxFQUFFLEVBQUU7WUFDeEMsSUFBTSxVQUFVLEdBQUcsVUFBVSxDQUFDLENBQUMsQ0FBQyxDQUFDO1lBQ2pDLFFBQVEsSUFBSSxNQUFJLFVBQVUsQ0FBQyxTQUFTLFlBQU8sVUFBVSxDQUFDLEtBQUssTUFBRyxDQUFDO1lBRS9ELElBQUksQ0FBQyxHQUFHLFVBQVUsQ0FBQyxNQUFNLEdBQUcsQ0FBQyxFQUFFO2dCQUMzQixRQUFRLElBQUksSUFBSSxDQUFDO2FBQ3BCO1NBQ0o7UUFDRCxRQUFRLElBQUksSUFBSSxDQUFDO1FBRWpCLE9BQU8sUUFBUSxDQUFDO0lBQ3BCLENBQUM7SUF2SlEsaUJBQWlCO1FBRDdCLFVBQVUsRUFBRTtPQUNBLGlCQUFpQixDQXlKN0I7SUFBRCx3QkFBQztDQUFBLEFBekpELENBQXVDLGtCQUFrQixHQXlKeEQ7U0F6SlksaUJBQWlCIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHsgR3JpZEJhc2VBUElTZXJ2aWNlIH0gZnJvbSAnLi4vYXBpLnNlcnZpY2UnO1xuaW1wb3J0IHsgSWd4R3JpZENvbXBvbmVudCB9IGZyb20gJy4vZ3JpZC5jb21wb25lbnQnO1xuaW1wb3J0IHsgSUdyb3VwQnlSZWNvcmQgfSBmcm9tICcuLi8uLi9kYXRhLW9wZXJhdGlvbnMvZ3JvdXBieS1yZWNvcmQuaW50ZXJmYWNlJztcbmltcG9ydCB7IElHcm91cEJ5RXhwYW5kU3RhdGUgfSBmcm9tICcuLi8uLi9kYXRhLW9wZXJhdGlvbnMvZ3JvdXBieS1leHBhbmQtc3RhdGUuaW50ZXJmYWNlJztcbmltcG9ydCB7IERhdGFVdGlsIH0gZnJvbSAnLi4vLi4vZGF0YS1vcGVyYXRpb25zL2RhdGEtdXRpbCc7XG5pbXBvcnQgeyBjbG9uZUFycmF5IH0gZnJvbSAnLi4vLi4vY29yZS91dGlscyc7XG5pbXBvcnQgeyBJR3JvdXBpbmdFeHByZXNzaW9uIH0gZnJvbSAnLi4vLi4vZGF0YS1vcGVyYXRpb25zL2dyb3VwaW5nLWV4cHJlc3Npb24uaW50ZXJmYWNlJztcbmltcG9ydCB7IEluamVjdGFibGUgfSBmcm9tICdAYW5ndWxhci9jb3JlJztcblxuQEluamVjdGFibGUoKVxuZXhwb3J0IGNsYXNzIElneEdyaWRBUElTZXJ2aWNlIGV4dGVuZHMgR3JpZEJhc2VBUElTZXJ2aWNlPElneEdyaWRDb21wb25lbnQ+IHtcblxuICAgIHB1YmxpYyBncm91cEJ5KGV4cHJlc3Npb246IElHcm91cGluZ0V4cHJlc3Npb24pOiB2b2lkIHtcbiAgICAgICAgY29uc3QgZ3JvdXBpbmdTdGF0ZSA9IGNsb25lQXJyYXkodGhpcy5ncmlkLmdyb3VwaW5nRXhwcmVzc2lvbnMpO1xuICAgICAgICBjb25zdCBzb3J0aW5nU3RhdGUgPSBjbG9uZUFycmF5KHRoaXMuZ3JpZC5zb3J0aW5nRXhwcmVzc2lvbnMpO1xuICAgICAgICB0aGlzLnByZXBhcmVfc29ydGluZ19leHByZXNzaW9uKFtzb3J0aW5nU3RhdGUsIGdyb3VwaW5nU3RhdGVdLCBleHByZXNzaW9uKTtcbiAgICAgICAgdGhpcy5ncmlkLmdyb3VwaW5nRXhwcmVzc2lvbnMgPSBncm91cGluZ1N0YXRlO1xuICAgICAgICB0aGlzLmFycmFuZ2Vfc29ydGluZ19leHByZXNzaW9ucygpO1xuICAgIH1cblxuICAgIHB1YmxpYyBncm91cEJ5X211bHRpcGxlKGV4cHJlc3Npb25zOiBJR3JvdXBpbmdFeHByZXNzaW9uW10pOiB2b2lkIHtcbiAgICAgICAgY29uc3QgZ3JvdXBpbmdTdGF0ZSA9IGNsb25lQXJyYXkodGhpcy5ncmlkLmdyb3VwaW5nRXhwcmVzc2lvbnMpO1xuICAgICAgICBjb25zdCBzb3J0aW5nU3RhdGUgPSBjbG9uZUFycmF5KHRoaXMuZ3JpZC5zb3J0aW5nRXhwcmVzc2lvbnMpO1xuXG4gICAgICAgIGZvciAoY29uc3QgZWFjaCBvZiBleHByZXNzaW9ucykge1xuICAgICAgICAgICAgdGhpcy5wcmVwYXJlX3NvcnRpbmdfZXhwcmVzc2lvbihbc29ydGluZ1N0YXRlLCBncm91cGluZ1N0YXRlXSwgZWFjaCk7XG4gICAgICAgIH1cblxuICAgICAgICB0aGlzLmdyaWQuZ3JvdXBpbmdFeHByZXNzaW9ucyA9IGdyb3VwaW5nU3RhdGU7XG4gICAgICAgIHRoaXMuYXJyYW5nZV9zb3J0aW5nX2V4cHJlc3Npb25zKCk7XG4gICAgfVxuXG4gICAgcHVibGljIGNsZWFyX2dyb3VwYnkobmFtZT86IHN0cmluZyB8IEFycmF5PHN0cmluZz4pIHtcbiAgICAgICAgY29uc3QgZ3JvdXBpbmdTdGF0ZSA9IGNsb25lQXJyYXkodGhpcy5ncmlkLmdyb3VwaW5nRXhwcmVzc2lvbnMpO1xuICAgICAgICBjb25zdCBzb3J0aW5nU3RhdGUgPSBjbG9uZUFycmF5KHRoaXMuZ3JpZC5zb3J0aW5nRXhwcmVzc2lvbnMpO1xuXG4gICAgICAgIGlmIChuYW1lKSB7XG4gICAgICAgICAgICBjb25zdCBuYW1lcyA9IHR5cGVvZiBuYW1lID09PSAnc3RyaW5nJyA/IFsgbmFtZSBdIDogbmFtZTtcbiAgICAgICAgICAgIGNvbnN0IGdyb3VwZWRDb2xzID0gZ3JvdXBpbmdTdGF0ZS5maWx0ZXIoKHN0YXRlKSA9PiBuYW1lcy5pbmRleE9mKHN0YXRlLmZpZWxkTmFtZSkgPCAwKTtcbiAgICAgICAgICAgIGNvbnN0IG5ld1NvcnRpbmdFeHByID0gc29ydGluZ1N0YXRlLmZpbHRlcigoc3RhdGUpID0+IG5hbWVzLmluZGV4T2Yoc3RhdGUuZmllbGROYW1lKSA8IDApO1xuICAgICAgICAgICAgdGhpcy5ncmlkLmdyb3VwaW5nRXhwcmVzc2lvbnMgPSBncm91cGVkQ29scztcbiAgICAgICAgICAgIHRoaXMuZ3JpZC5zb3J0aW5nRXhwcmVzc2lvbnMgPSBuZXdTb3J0aW5nRXhwcjtcbiAgICAgICAgICAgIG5hbWVzLmZvckVhY2goKGNvbE5hbWUpID0+IHtcbiAgICAgICAgICAgICAgICBjb25zdCBnckV4cHJJbmRleCA9IGdyb3VwaW5nU3RhdGUuZmluZEluZGV4KChleHApID0+IGV4cC5maWVsZE5hbWUgPT09IGNvbE5hbWUpO1xuICAgICAgICAgICAgICAgIGNvbnN0IGdycEV4cGFuZFN0YXRlID0gdGhpcy5ncmlkLmdyb3VwaW5nRXhwYW5zaW9uU3RhdGU7XG4gICAgICAgICAgICAgICAgIC8qIHJlbW92ZSBleHBhbnNpb24gc3RhdGVzIHJlbGF0ZWQgdG8gdGhlIGNsZWFyZWQgZ3JvdXBcbiAgICAgICAgICAgICAgICAgICAgYW5kIGFsbCB3aXRoIGRlZXBlciBoaWVyYXJjaHkgdGhhbiB0aGUgY2xlYXJlZCBncm91cCAqL1xuICAgICAgICAgICAgICAgIGNvbnN0IG5ld0V4cGFuZFN0YXRlID0gZ3JwRXhwYW5kU3RhdGUuZmlsdGVyKCh2YWwpID0+IHtcbiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIHZhbC5oaWVyYXJjaHkgJiYgdmFsLmhpZXJhcmNoeS5sZW5ndGggPD0gZ3JFeHBySW5kZXg7XG4gICAgICAgICAgICAgICAgfSk7XG4gICAgICAgICAgICAgICAgLyogRG8gbm90IHNldCB0aGUgbmV3IGluc3RhbmNlIHByb2R1Y2VkIGJ5IGZpbHRlclxuICAgICAgICAgICAgICAgICAgICB3aGVuIHRoZXJlIGFyZSBubyBkaWZmZXJlbmNlcyBiZXR3ZWVuIGV4cGFuc2lvbiBzdGF0ZXMgKi9cbiAgICAgICAgICAgICAgICBpZiAobmV3RXhwYW5kU3RhdGUubGVuZ3RoICE9PSBncnBFeHBhbmRTdGF0ZS5sZW5ndGgpIHtcbiAgICAgICAgICAgICAgICAgICB0aGlzLmdyaWQuZ3JvdXBpbmdFeHBhbnNpb25TdGF0ZSA9IG5ld0V4cGFuZFN0YXRlO1xuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgIH0pO1xuICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgLy8gY2xlYXIgYWxsXG4gICAgICAgICAgICB0aGlzLmdyaWQuZ3JvdXBpbmdFeHByZXNzaW9ucyA9IFtdO1xuICAgICAgICAgICAgdGhpcy5ncmlkLmdyb3VwaW5nRXhwYW5zaW9uU3RhdGUgPSBbXTtcbiAgICAgICAgICAgIGZvciAoY29uc3QgZ3JFeHByIG9mIGdyb3VwaW5nU3RhdGUpIHtcbiAgICAgICAgICAgICAgICBjb25zdCBzb3J0RXhwckluZGV4ID0gc29ydGluZ1N0YXRlLmZpbmRJbmRleCgoZXhwKSA9PiBleHAuZmllbGROYW1lID09PSBnckV4cHIuZmllbGROYW1lKTtcbiAgICAgICAgICAgICAgICBpZiAoc29ydEV4cHJJbmRleCA+IC0xKSB7XG4gICAgICAgICAgICAgICAgICAgIHNvcnRpbmdTdGF0ZS5zcGxpY2Uoc29ydEV4cHJJbmRleCwgMSk7XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgfVxuICAgICAgICAgICAgdGhpcy5ncmlkLnNvcnRpbmdFeHByZXNzaW9ucyA9IHNvcnRpbmdTdGF0ZTtcbiAgICAgICAgfVxuICAgIH1cblxuICAgIHB1YmxpYyBncm91cEJ5X2dldF9leHBhbmRlZF9mb3JfZ3JvdXAoZ3JvdXBSb3c6IElHcm91cEJ5UmVjb3JkKTogSUdyb3VwQnlFeHBhbmRTdGF0ZSB7XG4gICAgICAgIGNvbnN0IGdyU3RhdGUgPSB0aGlzLmdyaWQuZ3JvdXBpbmdFeHBhbnNpb25TdGF0ZTtcbiAgICAgICAgY29uc3QgaGllcmFyY2h5ID0gRGF0YVV0aWwuZ2V0SGllcmFyY2h5KGdyb3VwUm93KTtcbiAgICAgICAgcmV0dXJuIGdyU3RhdGUuZmluZCgoc3RhdGUpID0+XG4gICAgICAgICAgICBEYXRhVXRpbC5pc0hpZXJhcmNoeU1hdGNoKHN0YXRlLmhpZXJhcmNoeSB8fCBbeyBmaWVsZE5hbWU6IGdyb3VwUm93LmV4cHJlc3Npb24uZmllbGROYW1lLCB2YWx1ZTogZ3JvdXBSb3cudmFsdWUgfV0sIGhpZXJhcmNoeSkpO1xuICAgIH1cblxuICAgIHB1YmxpYyBncm91cEJ5X2lzX3Jvd19pbl9ncm91cChncm91cFJvdzogSUdyb3VwQnlSZWNvcmQsIHJvd0lEKTogYm9vbGVhbiB7XG4gICAgICAgIGNvbnN0IGdyaWQgPSB0aGlzLmdyaWQ7XG4gICAgICAgIGxldCByb3dJbkdyb3VwID0gZmFsc2U7XG4gICAgICAgIGdyb3VwUm93LnJlY29yZHMuZm9yRWFjaChyb3cgPT4ge1xuICAgICAgICAgICAgaWYgKGdyaWQucHJpbWFyeUtleSA/IHJvd1tncmlkLnByaW1hcnlLZXldID09PSByb3dJRCA6IHJvdyA9PT0gcm93SUQpIHtcbiAgICAgICAgICAgICAgICByb3dJbkdyb3VwID0gdHJ1ZTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgfSk7XG4gICAgICAgIHJldHVybiByb3dJbkdyb3VwO1xuICAgIH1cblxuICAgIHB1YmxpYyBncm91cEJ5X3RvZ2dsZV9ncm91cChncm91cFJvdzogSUdyb3VwQnlSZWNvcmQpIHtcbiAgICAgICAgY29uc3QgZ3JpZCA9IHRoaXMuZ3JpZDtcbiAgICAgICAgaWYgKGdyaWQuY3J1ZFNlcnZpY2UuaXNJbkVkaXRNb2RlKSB7XG4gICAgICAgICAgICBncmlkLmVuZEVkaXQodHJ1ZSk7XG4gICAgICAgIH1cblxuICAgICAgICBjb25zdCBleHBhbnNpb25TdGF0ZSA9IGdyaWQuZ3JvdXBpbmdFeHBhbnNpb25TdGF0ZTtcbiAgICAgICAgY29uc3Qgc3RhdGU6IElHcm91cEJ5RXhwYW5kU3RhdGUgPSB0aGlzLmdyb3VwQnlfZ2V0X2V4cGFuZGVkX2Zvcl9ncm91cChncm91cFJvdyk7XG4gICAgICAgIGlmIChzdGF0ZSkge1xuICAgICAgICAgICAgc3RhdGUuZXhwYW5kZWQgPSAhc3RhdGUuZXhwYW5kZWQ7XG4gICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICBleHBhbnNpb25TdGF0ZS5wdXNoKHtcbiAgICAgICAgICAgICAgICBleHBhbmRlZDogIWdyaWQuZ3JvdXBzRXhwYW5kZWQsXG4gICAgICAgICAgICAgICAgaGllcmFyY2h5OiBEYXRhVXRpbC5nZXRIaWVyYXJjaHkoZ3JvdXBSb3cpXG4gICAgICAgICAgICB9KTtcbiAgICAgICAgfVxuICAgICAgICB0aGlzLmdyaWQuZ3JvdXBpbmdFeHBhbnNpb25TdGF0ZSA9IFsuLi5leHBhbnNpb25TdGF0ZV07XG4gICAgICAgIGlmIChncmlkLnJvd0VkaXRhYmxlKSB7XG4gICAgICAgICAgICBncmlkLnJlcG9zaXRpb25Sb3dFZGl0aW5nT3ZlcmxheShncmlkLnJvd0luRWRpdE1vZGUpO1xuICAgICAgICB9XG4gICAgfVxuXG4gICAgcHVibGljIGdyb3VwQnlfZnVsbHlfZXhwYW5kX2dyb3VwKGdyb3VwUm93OiBJR3JvdXBCeVJlY29yZCkge1xuICAgICAgICBjb25zdCBzdGF0ZTogSUdyb3VwQnlFeHBhbmRTdGF0ZSA9IHRoaXMuZ3JvdXBCeV9nZXRfZXhwYW5kZWRfZm9yX2dyb3VwKGdyb3VwUm93KTtcbiAgICAgICAgY29uc3QgZXhwYW5kZWQgPSBzdGF0ZSA/IHN0YXRlLmV4cGFuZGVkIDogdGhpcy5ncmlkLmdyb3Vwc0V4cGFuZGVkO1xuICAgICAgICBpZiAoIWV4cGFuZGVkKSB7XG4gICAgICAgICAgICB0aGlzLmdyb3VwQnlfdG9nZ2xlX2dyb3VwKGdyb3VwUm93KTtcbiAgICAgICAgfVxuICAgICAgICBpZiAoZ3JvdXBSb3cuZ3JvdXBQYXJlbnQpIHtcbiAgICAgICAgICAgIHRoaXMuZ3JvdXBCeV9mdWxseV9leHBhbmRfZ3JvdXAoZ3JvdXBSb3cuZ3JvdXBQYXJlbnQpO1xuICAgICAgICB9XG4gICAgfVxuXG4gICAgcHJvdGVjdGVkIHJlbW92ZV9ncm91cGluZ19leHByZXNzaW9uKGZpZWxkTmFtZSkge1xuICAgICAgICBjb25zdCBncm91cGluZ0V4cHJlc3Npb25zID0gdGhpcy5ncmlkLmdyb3VwaW5nRXhwcmVzc2lvbnM7XG4gICAgICAgIGNvbnN0IGluZGV4ID0gZ3JvdXBpbmdFeHByZXNzaW9ucy5maW5kSW5kZXgoKGV4cHIpID0+IGV4cHIuZmllbGROYW1lID09PSBmaWVsZE5hbWUpO1xuICAgICAgICBpZiAoaW5kZXggIT09IC0xKSB7XG4gICAgICAgICAgICBncm91cGluZ0V4cHJlc3Npb25zLnNwbGljZShpbmRleCwgMSk7XG4gICAgICAgIH1cbiAgICB9XG5cbiAgICBwdWJsaWMgYXJyYW5nZV9zb3J0aW5nX2V4cHJlc3Npb25zKCkge1xuICAgICAgICBjb25zdCBncm91cGluZ1N0YXRlID0gdGhpcy5ncmlkLmdyb3VwaW5nRXhwcmVzc2lvbnM7XG4gICAgICAgIHRoaXMuZ3JpZC5zb3J0aW5nRXhwcmVzc2lvbnMuc29ydCgoYSwgYikgPT4ge1xuICAgICAgICAgICAgY29uc3QgZ3JvdXBFeHByQSA9IGdyb3VwaW5nU3RhdGUuZmluZCgoZXhwcikgPT4gZXhwci5maWVsZE5hbWUgPT09IGEuZmllbGROYW1lKTtcbiAgICAgICAgICAgIGNvbnN0IGdyb3VwRXhwckIgPSBncm91cGluZ1N0YXRlLmZpbmQoKGV4cHIpID0+IGV4cHIuZmllbGROYW1lID09PSBiLmZpZWxkTmFtZSk7XG4gICAgICAgICAgICBpZiAoZ3JvdXBFeHByQSAmJiBncm91cEV4cHJCKSB7XG4gICAgICAgICAgICAgICAgcmV0dXJuIGdyb3VwaW5nU3RhdGUuaW5kZXhPZihncm91cEV4cHJBKSA+IGdyb3VwaW5nU3RhdGUuaW5kZXhPZihncm91cEV4cHJCKSA/IDEgOiAtMTtcbiAgICAgICAgICAgIH0gZWxzZSBpZiAoZ3JvdXBFeHByQSkge1xuICAgICAgICAgICAgICAgIHJldHVybiAtMTtcbiAgICAgICAgICAgIH0gZWxzZSBpZiAoZ3JvdXBFeHByQikge1xuICAgICAgICAgICAgICAgIHJldHVybiAxO1xuICAgICAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgICAgICByZXR1cm4gMDtcbiAgICAgICAgICAgIH1cbiAgICAgICAgfSk7XG4gICAgfVxuXG4gICAgcHVibGljIGdldF9ncm91cEJ5X3JlY29yZF9pZChnUm93OiBJR3JvdXBCeVJlY29yZCk6IHN0cmluZyB7XG4gICAgICAgIGxldCByZWNvcmRJZCA9ICd7ICc7XG4gICAgICAgIGNvbnN0IGhpZXJyYXJjaHkgPSBEYXRhVXRpbC5nZXRIaWVyYXJjaHkoZ1Jvdyk7XG5cbiAgICAgICAgZm9yIChsZXQgaSA9IDA7IGkgPCBoaWVycmFyY2h5Lmxlbmd0aDsgaSsrKSB7XG4gICAgICAgICAgICBjb25zdCBncm91cEJ5S2V5ID0gaGllcnJhcmNoeVtpXTtcbiAgICAgICAgICAgIHJlY29yZElkICs9IGAnJHtncm91cEJ5S2V5LmZpZWxkTmFtZX0nOiAnJHtncm91cEJ5S2V5LnZhbHVlfSdgO1xuXG4gICAgICAgICAgICBpZiAoaSA8IGhpZXJyYXJjaHkubGVuZ3RoIC0gMSkge1xuICAgICAgICAgICAgICAgIHJlY29yZElkICs9ICcsICc7XG4gICAgICAgICAgICB9XG4gICAgICAgIH1cbiAgICAgICAgcmVjb3JkSWQgKz0gJyB9JztcblxuICAgICAgICByZXR1cm4gcmVjb3JkSWQ7XG4gICAgfVxuXG59XG4iXX0=